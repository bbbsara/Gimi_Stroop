<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø³ØªØ±ÙˆØ¨ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
            text-align: center;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; 
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ */
        #start-screen, #instruction-screen, #end-screen {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        }

        h1, h2 { color: #333; margin-bottom: 20px; }
        
        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            font-family: 'Tajawal';
            box-sizing: border-box;
            text-align: center;
            background-color: #fff;
        }

        .main-btn, .retry-btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            font-family: 'Tajawal';
            width: 100%;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: right;
            font-size: 0.95rem;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
        #test-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            box-sizing: border-box;
        }

        .top-bar {
            width: 90%;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            color: #555;
            margin-top: 10px;
        }

        #word-box {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #word {
            font-size: 5rem;
            font-weight: 900;
        }

        #buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 90%;
            max-width: 400px;
            margin-bottom: 30px;
        }
        
        #buttons .btn:last-child:nth-child(odd) {
            grid-column: span 2;
        }

        .btn {
            padding: 25px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        .hidden { display: none !important; }
    </style>
</head>

<body>

    <div id="start-screen">
        <h1>Ø§Ø®ØªØ¨Ø§Ø± Ø³ØªØ±ÙˆØ¨ (Ø¹Ù„Ù…ÙŠ)</h1>
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡:</p>
        
        <input type="text" id="student-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" autocomplete="off">
        <input type="text" id="student-grade" placeholder="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø±Ø§Ø¨Ø¹)" autocomplete="off">
        <select id="student-gender">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
            <option value="Male">Ø°ÙƒØ±</option>
            <option value="Female">Ø£Ù†Ø«Ù‰</option>
        </select>

        <button id="start-btn" class="main-btn" onclick="goToInstructions()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        
        <div class="info-box">
            <h3>ÙŠØªÙƒÙˆÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ù…Ø±Ø­Ù„ØªÙŠÙ†:</h3>
            <p>1ï¸âƒ£ <strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰:</strong> Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚ (Ø³Ù‡Ù„Ø©).</p>
            <p>2ï¸âƒ£ <strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©:</strong> Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ø§Ø±Ø¶ (ØµØ¹Ø¨Ø©).</p>
        </div>
    </div>

    <div id="instruction-screen" class="hidden">
        <h2 id="phase-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©</h2>
        <div id="phase-desc" style="line-height:1.8; margin-bottom:20px;">ÙˆØµÙ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
        <button id="phase-start-btn" class="main-btn" onclick="startPhase()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
    </div>

    <div id="test-container" class="hidden">
        <div class="top-bar">
            <div id="phase-indicator">Ø§Ù„Ù…Ø±Ø­Ù„Ø©: 1</div>
            <div id="timer">0.0 Ø«</div>
            <div id="counter">0 / 20</div>
        </div>

        <div id="word-box">
            <div id="word">---</div>
        </div>

        <div id="buttons">
            <button class="btn" onclick="handleInput('Ø£Ø­Ù…Ø±')" style="background-color: #ff3b30;"></button>
            <button class="btn" onclick="handleInput('Ø£Ø²Ø±Ù‚')" style="background-color: #007aff;"></button>
            <button class="btn" onclick="handleInput('Ø£Ø®Ø¶Ø±')" style="background-color: #4cd964;"></button>
            <button class="btn" onclick="handleInput('Ø£ØµÙØ±')" style="background-color: #ffeb3b;"></button>
            <button class="btn" onclick="handleInput('Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ')" style="background-color: #ff9500;"></button>
        </div>
    </div>

    <div id="end-screen" class="hidden">
        <h2>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
        <div class="result-box" style="text-align:right;">
            <p><strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> <span id="res-name"></span></p>
            <hr>
            <p>â±ï¸ Ø²Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ù‡Ù„Ø©: <span id="res-p1"></span></p>
            <p>âŒ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ù‡Ù„Ø©: <span id="res-p1-wrong" style="color:red"></span></p>
            <hr>
            <p>â±ï¸ Ø²Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØµØ¹Ø¨Ø©: <span id="res-p2"></span></p>
            <p>âŒ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØµØ¹Ø¨Ø©: <span id="res-p2-wrong" style="color:red"></span></p>
            <hr>
            <p style="background:#e3f2fd; padding:10px; border-radius:5px; text-align:center;">
                ğŸ§  <strong>ØªØ£Ø«ÙŠØ± Ø³ØªØ±ÙˆØ¨:</strong> <span id="res-stroop" style="font-weight:bold; color:#007aff; font-size:1.2rem;"></span> ms
                <br><small>(Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø­Ù„ØªÙŠÙ†)</small>
            </p>
        </div>
        <p id="status-msg" style="color:gray; margin-top:10px;">Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        <button onclick="location.reload()" class="retry-btn">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <script>
        // ========================================================
        // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ Ø¨Ù†Ø¬Ø§Ø­ âœ…
        // ========================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3rdilBJSLLiy7xkfctJ0Mi3kRxo_7ds38KzbHzRyGKoq1jy_wgJw3neKxIEDHtV3a/exec"; 

        let studentData = { name: "", grade: "", gender: "" };

        const colors = [
            { name: "Ø£Ø­Ù…Ø±", code: "#ff3b30" },
            { name: "Ø£Ø²Ø±Ù‚", code: "#007aff" },
            { name: "Ø£Ø®Ø¶Ø±", code: "#4cd964" },
            { name: "Ø£ØµÙØ±", code: "#ffeb3b" },
            { name: "Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ", code: "#ff9500" }
        ];

        let phases = [
            { 
                id: 1, 
                name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„ØªÙˆØ§ÙÙ‚)", 
                desc: "ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŒ Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†ÙØ³ Ù„ÙˆÙ† Ø§Ù„Ø®Ø·.<br>Ù…Ø«Ø§Ù„: ÙƒÙ„Ù…Ø© <span style='color:red; font-weight:bold'>Ø£Ø­Ù…Ø±</span> Ø³ØªÙƒÙˆÙ† Ù…Ù„ÙˆÙ†Ø© Ø¨Ø§Ù„Ø£Ø­Ù…Ø±.<br>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø°ÙŠ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù„ÙˆÙ†.",
                trials: 20, 
                type: "congruent" 
            },
            { 
                id: 2, 
                name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø§Ù„ØªØ¹Ø§Ø±Ø¶)", 
                desc: "ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŒ Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ† Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù!<br>Ù…Ø«Ø§Ù„: ÙƒÙ„Ù…Ø© <strong>Ø£Ø­Ù…Ø±</strong> Ø³ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ù„ÙˆÙ† <span style='color:blue; font-weight:bold'>Ø§Ù„Ø£Ø²Ø±Ù‚</span>.<br>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>Ù„ÙˆÙ† Ø§Ù„Ø®Ø·</strong>.",
                trials: 20, 
                type: "incongruent" 
            }
        ];

        let currentPhaseIndex = 0;
        let currentTrial = 0;
        let trialsData = [];
        let startTime = 0;
        
        let results = {
            p1_time: 0, p1_wrong: 0,
            p2_time: 0, p2_wrong: 0
        };

        function goToInstructions() {
            const name = document.getElementById('student-name').value.trim();
            const grade = document.getElementById('student-grade').value.trim();
            const gender = document.getElementById('student-gender').value;

            if (!name || !grade || !gender) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŒ Ø§Ù„Ø¬Ù†Ø³)");
                return;
            }

            studentData.name = name;
            studentData.grade = grade;
            studentData.gender = gender;

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('instruction-screen').classList.remove('hidden');
            setupPhaseInfo();
        }

        function setupPhaseInfo() {
            const phase = phases[currentPhaseIndex];
            document.getElementById('phase-title').innerText = phase.name;
            document.getElementById('phase-desc').innerHTML = phase.desc;
        }

        function startPhase() {
            document.getElementById('instruction-screen').classList.add('hidden');
            document.getElementById('test-container').classList.remove('hidden');
            
            document.getElementById('phase-indicator').innerText = `Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${currentPhaseIndex + 1}`;
            currentTrial = 0;
            trialsData = generateTrials(phases[currentPhaseIndex]);
            
            if(currentPhaseIndex === 0) results.p1_wrong = 0;
            else results.p2_wrong = 0;

            nextTrial();
        }

        function generateTrials(phase) {
            let generated = [];
            for (let i = 0; i < phase.trials; i++) {
                let textObj = colors[Math.floor(Math.random() * colors.length)];
                let colorObj;

                if (phase.type === "congruent") {
                    colorObj = textObj;
                } else {
                    do {
                        colorObj = colors[Math.floor(Math.random() * colors.length)];
                    } while (colorObj.name === textObj.name);
                }
                generated.push({ text: textObj.name, colorCode: colorObj.code, colorName: colorObj.name });
            }
            return generated;
        }

        function nextTrial() {
            if (currentTrial >= trialsData.length) {
                endPhase();
                return;
            }

            const trial = trialsData[currentTrial];
            const wordEl = document.getElementById('word');
            
            wordEl.innerText = trial.text;
            wordEl.style.color = trial.colorCode;
            document.getElementById('counter').innerText = `${currentTrial + 1} / ${phases[currentPhaseIndex].trials}`;

            startTime = Date.now();
        }

        function handleInput(selectedColor) {
            const trial = trialsData[currentTrial];
            const endTime = Date.now();
            const timeTaken = endTime - startTime;

            if (selectedColor === trial.colorName) {
                if (currentPhaseIndex === 0) results.p1_time += timeTaken;
                else results.p2_time += timeTaken;
                
                currentTrial++;
                setTimeout(nextTrial, 100);
            } else {
                if (currentPhaseIndex === 0) results.p1_wrong++;
                else results.p2_wrong++;
                
                document.body.style.backgroundColor = "#ffebee";
                setTimeout(() => { document.body.style.backgroundColor = "#f0f2f5"; }, 200);
            }
        }

        function endPhase() {
            document.getElementById('test-container').classList.add('hidden');
            
            if (currentPhaseIndex < phases.length - 1) {
                currentPhaseIndex++;
                document.getElementById('instruction-screen').classList.remove('hidden');
                setupPhaseInfo();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('end-screen').classList.remove('hidden');
            
            const avgTime = Math.round((results.p1_time + results.p2_time) / (phases[0].trials + phases[1].trials));
            const stroopEffect = Math.round(results.p2_time - results.p1_time);

            document.getElementById('res-name').innerText = studentData.name;
            document.getElementById('res-p1').innerText = (results.p1_time / 1000).toFixed(2) + " Ø«";
            document.getElementById('res-p1-wrong').innerText = results.p1_wrong;
            document.getElementById('res-p2').innerText = (results.p2_time / 1000).toFixed(2) + " Ø«";
            document.getElementById('res-p2-wrong').innerText = results.p2_wrong;
            document.getElementById('res-stroop').innerText = stroopEffect;
            document.getElementById('res-avg').innerText = avgTime + " ms";

            sendDataToSheet(avgTime, stroopEffect);
        }

        function sendDataToSheet(avg, effect) {
            const dataToSend = {
                name: studentData.name,
                grade: studentData.grade,
                gender: studentData.gender,
                p1_time: (results.p1_time / 1000).toFixed(2),
                p1_wrong: results.p1_wrong,
                p2_time: (results.p2_time / 1000).toFixed(2),
                p2_wrong: results.p2_wrong,
                avg_time: avg,
                stroop_effect: effect
            };

            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dataToSend)
            }).then(() => {
                document.getElementById('status-msg').innerHTML = "<b style='color:green'>âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­!</b>";
            }).catch(err => {
                document.getElementById('status-msg').innerHTML = "<b style='color:red'>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.</b>";
            });
        }
    </script>
</body>
</html>
